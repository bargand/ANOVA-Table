<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ANOVA Statistical Calculator</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #2cc197;
        --primary-dark: #178e58;
        --primary-light: #e0f7f1;
        --dark-bg: #031b1b;
        --darker-bg: #021414;
        --card-bg: #052323;
        --text-light: #f0f0f0;
        --text-muted: #a0a0a0;
        --border-radius: 8px;
        --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        --transition: all 0.3s ease;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        width: 100%;
        min-height: 100vh;
        font-family: "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background-color: var(--dark-bg);
        color: var(--text-light);
        line-height: 1.6;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
      }

      /* Header Styles */
      header {
        background-color: var(--darker-bg);
        padding: 1rem 2rem;
        box-shadow: var(--box-shadow);
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo i {
        color: var(--primary);
        font-size: 1.5rem;
      }

      .logo h1 {
        font-size: 1.3rem;
        color: var(--primary);
        font-weight: 600;
      }

      /* Main Content Layout */
      .app-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      }

      .app-header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .app-header h2 {
        color: var(--primary);
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
      }

      .app-header p {
        color: var(--text-muted);
        max-width: 700px;
        margin: 0 auto;
      }

      /* Stepper Navigation */
      .stepper {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        min-width: 100px;
      }

      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--card-bg);
        color: var(--text-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 0.5rem;
        border: 2px solid var(--primary);
        transition: var(--transition);
      }

      .step.active .step-number {
        background-color: var(--primary);
        color: var(--dark-bg);
      }

      .step.completed .step-number {
        background-color: var(--primary-dark);
        color: white;
      }

      .step-label {
        font-size: 0.9rem;
        color: var(--text-muted);
        text-align: center;
      }

      .step.active .step-label {
        color: var(--primary);
        font-weight: 500;
      }

      /* Form Controls */
      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-light);
        font-weight: 500;
      }

      .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--primary);
        border-radius: var(--border-radius);
        background-color: var(--card-bg);
        color: var(--text-light);
        font-size: 1rem;
        transition: var(--transition);
        max-width: 300px;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(44, 193, 151, 0.2);
      }

      /* Button Styles */
      .btn {
        padding: 0.75rem 1.5rem;
        background-color: var(--primary);
        color: var(--dark-bg);
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--box-shadow);
      }

      .btn:disabled {
        background-color: #04634d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        opacity: 0.7;
      }

      .btn-secondary {
        background-color: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
      }

      .btn-secondary:hover {
        background-color: rgba(44, 193, 151, 0.1);
      }

      .btn-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
      }

      /* Card Layouts */
      .card {
        background-color: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--box-shadow);
        margin-bottom: 2rem;
        transition: var(--transition);
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(44, 193, 151, 0.2);
      }

      .card-title {
        color: var(--primary);
        font-size: 1.2rem;
        font-weight: 600;
      }

      /* Table Styles */
      .table-responsive {
        overflow-x: auto;
        margin: 1.5rem 0;
        -webkit-overflow-scrolling: touch;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        font-size: 0.95rem;
      }

      th,
      td {
        border: 1px solid var(--primary);
        padding: 0.75rem;
        text-align: center;
      }

      th {
        background-color: rgba(44, 193, 151, 0.2);
        color: var(--primary);
        font-weight: 600;
      }

      td input[type="number"] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid rgba(44, 193, 151, 0.5);
        border-radius: 4px;
        background-color: rgba(44, 193, 151, 0.1);
        color: var(--text-light);
        text-align: center;
      }

      /* Formula Boxes */
      .formula-box {
        background-color: rgba(44, 193, 151, 0.1);
        border-left: 4px solid var(--primary);
        padding: 1.5rem;
        margin: 1.5rem 0;
        border-radius: 0 var(--border-radius) var(--border-radius) 0;
      }

      .formula-title {
        color: var(--primary);
        margin-bottom: 1rem;
        font-weight: 600;
      }

      .formula-item {
        margin-bottom: 0.75rem;
        display: flex;
        align-items: baseline;
      }

      .formula-item strong {
        color: var(--primary-light);
        min-width: 120px;
        display: inline-block;
      }

      /* Results Section */
      .results-summary {
        background-color: rgba(44, 193, 151, 0.05);
        border: 1px solid var(--primary);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-top: 2rem;
      }

      .results-title {
        color: var(--primary);
        margin-bottom: 1rem;
        font-size: 1.3rem;
      }

      /* Floating Action Button */
      .fab {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: var(--primary);
        color: var(--dark-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: var(--box-shadow);
        cursor: pointer;
        transition: var(--transition);
        z-index: 99;
        border: none;
      }

      .fab:hover {
        background-color: var(--primary-dark);
        transform: scale(1.1);
      }

      /* Utility Classes */
      .text-primary {
        color: var(--primary);
      }

      .text-muted {
        color: var(--text-muted);
      }

      .mt-1 {
        margin-top: 0.5rem;
      }
      .mt-2 {
        margin-top: 1rem;
      }
      .mt-3 {
        margin-top: 1.5rem;
      }
      .mt-4 {
        margin-top: 2rem;
      }
      .mb-1 {
        margin-bottom: 0.5rem;
      }
      .mb-2 {
        margin-bottom: 1rem;
      }
      .mb-3 {
        margin-bottom: 1.5rem;
      }
      .mb-4 {
        margin-bottom: 2rem;
      }

      /* Responsive Adjustments */
      @media (max-width: 768px) {
        .app-container {
          padding: 1rem;
        }

        .stepper {
          gap: 0.5rem;
        }

        .step {
          min-width: 80px;
        }

        .step-label {
          font-size: 0.8rem;
        }

        .card {
          padding: 1rem;
        }

        th,
        td {
          padding: 0.5rem;
          font-size: 0.85rem;
        }

        .fab {
          width: 50px;
          height: 50px;
          font-size: 1.2rem;
          bottom: 1rem;
          right: 1rem;
        }
      }

      @media (max-width: 480px) {
        header {
          padding: 1rem;
        }

        .logo h1 {
          font-size: 1.1rem;
        }

        .app-header h2 {
          font-size: 1.4rem;
        }

        .form-control {
          max-width: 100%;
        }

        .btn {
          width: 100%;
          justify-content: center;
        }

        .btn-group {
          flex-direction: column;
        }

        .step-number {
          width: 30px;
          height: 30px;
          font-size: 0.9rem;
        }
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.4s ease-out forwards;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--card-bg);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">
        <i class="fas fa-calculator"></i>
        <h1>ANOVA Pro</h1>
      </div>
      <div class="text-muted">Statistical Analysis Tool</div>
    </header>

    <div class="app-container">
      <div class="app-header">
        <h2>Multi-Location ANOVA Calculator</h2>
        <p>
          Perform analysis of variance across multiple locations with this
          comprehensive statistical tool
        </p>
      </div>

      <!-- Stepper Navigation -->
      <div class="stepper">
        <div class="step active" id="step1">
          <div class="step-number">1</div>
          <div class="step-label">Setup Locations</div>
        </div>
        <div class="step" id="step2">
          <div class="step-number">2</div>
          <div class="step-label">Enter Data</div>
        </div>
        <div class="step" id="step3">
          <div class="step-number">3</div>
          <div class="step-label">Calculate</div>
        </div>
        <div class="step" id="step4">
          <div class="step-number">4</div>
          <div class="step-label">Results</div>
        </div>
      </div>

      <!-- Step 1: Location Setup -->
      <div class="card fade-in" id="setupCard">
        <div class="card-header">
          <h3 class="card-title">Experiment Setup</h3>
          <i class="fas fa-flask text-primary"></i>
        </div>
        <div class="form-group">
          <label for="locationCount" class="form-label"
            >Number of Locations</label
          >
          <input
            type="number"
            id="locationCount"
            min="1"
            class="form-control"
            placeholder="e.g. 3"
            oninput="resetButtons()"
          />
          <small class="text-muted"
            >Enter how many different locations your experiment includes</small
          >
        </div>
        <div class="btn-group">
          <button id="nextBtn" class="btn" onclick="generateInputFields()">
            <i class="fas fa-arrow-right"></i> Continue
          </button>
        </div>
      </div>

      <!-- Step 2: Location Details -->
      <div class="card fade-in" id="locationDetailsCard" style="display: none">
        <div class="card-header">
          <h3 class="card-title">Location Specifications</h3>
          <i class="fas fa-map-marker-alt text-primary"></i>
        </div>
        <div id="inputFields"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="backToSetup()">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button id="generateTablesBtn" class="btn" onclick="generateTables()">
            <i class="fas fa-table"></i> Create Data Tables
          </button>
        </div>
      </div>

      <!-- Step 3: Data Tables -->
      <div class="card fade-in" id="dataTablesCard" style="display: none">
        <div class="card-header">
          <h3 class="card-title">Experimental Data</h3>
          <i class="fas fa-database text-primary"></i>
        </div>
        <div class="container" id="tablesContainer"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="backToDetails()">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button id="calculateBtn" class="btn" onclick="calculateTotals()">
            <i class="fas fa-calculator"></i> Calculate ANOVA
          </button>
        </div>
      </div>

      <!-- Step 4: Results -->
      <div id="resultsSection" style="display: none">
        <div class="card fade-in">
          <div class="card-header">
            <h3 class="card-title">ANOVA Results</h3>
            <i class="fas fa-chart-bar text-primary"></i>
          </div>
          <div id="summaryTableContainer"></div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="backToTables()">
              <i class="fas fa-arrow-left"></i> Back
            </button>
            <button
              id="summaryBtn"
              class="btn"
              onclick="generateSummaryTable()"
            >
              <i class="fas fa-file-alt"></i> Generate Full Report
            </button>
          </div>
        </div>

        <div class="card fade-in" id="fullReportCard" style="display: none">
          <div class="card-header">
            <h3 class="card-title">Comprehensive Analysis</h3>
            <i class="fas fa-file-alt text-primary"></i>
          </div>
          <div id="summaryStatsContainer"></div>
          <div id="SummaryAnovaResults"></div>
        </div>
      </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="downloadBtn" title="Download Results">
      <i class="fas fa-download"></i>
    </button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
      let globalTotalErrorsSumPooled = 0;
      let globalTotalESSumPooled = 0;
      let globalTotalMSSumPooled = 0;

      function resetButtons() {
        document.getElementById("nextBtn").disabled = false;
        document.getElementById("generateTablesBtn").disabled = false;
        document.getElementById("calculateBtn").disabled = false;
        document.getElementById("summaryBtn").disabled = false;
      }

      function generateInputFields() {
        const locationCount = document.getElementById("locationCount").value;
        const inputFieldsDiv = document.getElementById("inputFields");
        inputFieldsDiv.innerHTML = "";

        for (let i = 1; i <= locationCount; i++) {
          inputFieldsDiv.innerHTML += `
                    <div>
                        <h4>Location ${i}</h4>
                        <label>Replication Count:</label>
                        <input type="number" id="replicationCount${i}" min="1" size="5">
                        <label>Treatment Count:</label>
                        <input type="number" id="treatmentCount${i}" min="1" size="5">
                    </div>
                `;
        }
        document.getElementById("nextBtn").disabled = true;
        document.getElementById("generateTablesBtn").style.display = "block";

        document.getElementById("setupCard").style.display = "none";
        document.getElementById("locationDetailsCard").style.display = "block";
        updateStepper(2);
      }

      function generateTables() {
        const locationCount = document.getElementById("locationCount").value;
        if (!locationCount || locationCount < 1) return;
        const tablesContainer = document.getElementById("tablesContainer");
        tablesContainer.innerHTML = "";

        for (let i = 1; i <= locationCount; i++) {
          const repCount = document.getElementById(
            `replicationCount${i}`
          ).value;
          const treatCount = document.getElementById(
            `treatmentCount${i}`
          ).value;

          let tableHTML = `<div class="location-section">
                    <h4>Location ${i}</h4>
                    <table>
                        <tr>
                            <th>Treatment</th>`;
          for (let j = 1; j <= repCount; j++) {
            tableHTML += `<th>R${j}</th>`;
          }
          tableHTML += `<th>Total</th><th>Mean</th></tr>`;

          for (let k = 1; k <= treatCount; k++) {
            tableHTML += `<tr>
                        <td>Treatment ${k}</td>`;
            for (let j = 1; j <= repCount; j++) {
              tableHTML += `<td><input type="number" id="loc${i}treat${k}rep${j}" placeholder="0" size="5"></td>`;
            }
            tableHTML += `<td id="loc${i}treat${k}total">0</td>
                                  <td id="loc${i}treat${k}mean">0</td>
                    </tr>`;
          }
          tableHTML += `</table>
                    <div class="summary">
                        <p><strong>Replication Count:</strong> ${repCount}</p>
                        <p><strong>Treatment Count:</strong> ${treatCount}</p>
                        <p><strong>Grand Total:</strong> <span id="grandTotal${i}">0</span></p>
                    </div>
                </div>`;

          tablesContainer.innerHTML += tableHTML;
        }
        document.getElementById("generateTablesBtn").disabled = true;
        document.getElementById("calculateBtn").style.display = "block";

        document.getElementById("locationDetailsCard").style.display = "none";
        document.getElementById("dataTablesCard").style.display = "block";
        updateStepper(3);
      }

      function calculateTotals() {
        const locationCount = document.getElementById("locationCount").value;

        let totalErrorsSumPooled = 0;
        let totalESSumPooled = 0; // Store sum of Error Sum of Squares (ESS) across all locations
        let totalMSSumPooled = 0; // Store sum of Mean Sum of Squares (MSS) across all locations

        for (let i = 1; i <= locationCount; i++) {
          const repCount = parseInt(
            document.getElementById(`replicationCount${i}`).value
          );
          const treatCount = parseInt(
            document.getElementById(`treatmentCount${i}`).value
          );
          let grandTotal = 0;

          let columnTotals = new Array(repCount).fill(0); // Stores totals for each replication
          let treatmentSums = []; // Stores treatment totals for TrSS
          let sumOfSquares = 0; // Stores sum of squares of all values
          let sumOfSquaresFormula = []; // Stores squared values for formula display

          for (let k = 1; k <= treatCount; k++) {
            let total = 0;
            for (let j = 1; j <= repCount; j++) {
              let cellValue =
                Number(
                  document.getElementById(`loc${i}treat${k}rep${j}`).value
                ) || 0;
              total += cellValue;
              columnTotals[j - 1] += cellValue;
              sumOfSquares += cellValue ** 2;
              sumOfSquaresFormula.push(`${cellValue}Â²`); // Store squared values
            }
            let mean = total / repCount;
            document.getElementById(`loc${i}treat${k}total`).innerText = total;
            document.getElementById(`loc${i}treat${k}mean`).innerText =
              mean.toFixed(2);
            grandTotal += total;
            treatmentSums.push(total);
          }

          let N = treatCount * repCount; // Total number of observations
          let correctionFactor = grandTotal ** 2 / N; // C.F.

          // Total Sum of Squares (TSS)
          let totalSumOfSquares = sumOfSquares - correctionFactor;

          // Treatment Sum of Squares (TrSS)
          let treatmentSumOfSquares = treatmentSums.reduce(
            (sum, value) => sum + value ** 2,
            0
          );
          let treatmentSquaresFormula = treatmentSums
            .map((value) => `${value}Â²`)
            .join(" + "); // Show formula breakdown
          let finalTreatmentSum =
            treatmentSumOfSquares / repCount - correctionFactor;

          // Replication Sum of Squares (RSS)
          let replicationSumOfSquares = columnTotals.reduce(
            (sum, value) => sum + value ** 2,
            0
          );
          let replicationFormula = columnTotals
            .map((value) => `${value}Â²`)
            .join(" + ");
          let finalReplicationSum =
            replicationSumOfSquares / treatCount - correctionFactor;

          // Error Sum of Squares (ESS)
          let errorSumOfSquares =
            totalSumOfSquares - (finalTreatmentSum + finalReplicationSum);

          // Degrees of Freedom (df)
          let dfTreatment = treatCount - 1;
          let dfReplication = repCount - 1;
          let dfError = dfTreatment * dfReplication; // Error for this location
          totalErrorsSumPooled += dfError; // Accumulate errors
          totalESSumPooled += errorSumOfSquares; // Accumulate ESS

          // Mean Sum of Squares (MSS)
          let meanTreatmentSS = finalTreatmentSum / dfTreatment;
          let meanReplicationSS = finalReplicationSum / dfReplication;
          let meanErrorSS = errorSumOfSquares / dfError;

          totalMSSumPooled += meanErrorSS; // Accumulate MSS

          // F-Calculated (Fcal)
          let fcalTreatment = meanTreatmentSS / meanErrorSS;
          let fcalReplication = meanReplicationSS / meanErrorSS;

          let MeanOfGrandMean = (grandTotal / N).toFixed(2);

          //Error co-efficient of variance
          let EnvRut = Math.sqrt(meanErrorSS);
          let EnvironCoffVariance = (EnvRut / MeanOfGrandMean).toFixed(2);

          //Genotypic co-efficient of varience
          let genotype = ((meanTreatmentSS - meanErrorSS) / repCount).toFixed(
            2
          );
          let GeanRut = Math.sqrt(genotype);
          let GeanCoffVariance = (GeanRut / MeanOfGrandMean).toFixed(2);

          //Phenotypic Co-efficient of Variance
          let phenotype = (parseFloat(genotype) + meanErrorSS).toFixed(2);
          let PhinoRut = Math.sqrt(phenotype);
          let PhenoCoffVariance = (PhinoRut / MeanOfGrandMean).toFixed(2);

          // Generate ANOVA Table
          let anovaTableHTML = `
            <h3>ANOVA Table for Location ${i}</h3>
            <table>
            <tr>
              <th>Source of Variation</th>
              <th>Degree of Freedom (d.f)</th>
              <th>Sum of Square (SS)</th>
              <th>Mean Sum of Square (MSS)</th>
              <th>F<sub>cal</sub></th>
              <th>E<sub>MSS</sub></th>
            </tr>
            <tr>
              <td><b>Treatment (T)</b></td>
              <td>(Total number of treatments - 1)<br><br><b>${dfTreatment}</b></td>
              <td>TrSS=<br><br><b>${finalTreatmentSum.toFixed(2)}</b></td>
              <td><b>(A)â†’</b>TrSS<hr class="Display_Divided">(Total number of treatments - 1)<br><br><b>${meanTreatmentSS.toFixed(
                2
              )}</b></td>
              <td>A<hr class="Display_Divided">C<br><br><b>${fcalTreatment.toFixed(
                2
              )}</b></td>
              <td>(ÏƒÂ²e + RÏƒÂ²g)<br><br><b>${meanTreatmentSS.toFixed(2)}</b></td>
            </tr>
            <tr>
              <td><b>Replication (R)</b></td>
              <td>(Total number of replication - 1)<br><br><b>${dfReplication}</b></td>
              <td>RSS=<br><br><b>${finalReplicationSum.toFixed(2)}</b></td>
              <td><RSS><b>(B)â†’</b>RSS<hr class="Display_Divided">(Total number of replication - 1)<br><br><b>${meanReplicationSS.toFixed(
                2
              )}</b></td>
              <td>B<hr class="Display_Divided">C<br><br><b>${fcalReplication.toFixed(
                2
              )}</b></td>
              <td>-</td>
            </tr>
            <tr>
              <td><b>Error (E)</b></td>
              <td><b>(Z)â†’</b> (Total number of treatments - 1) Ã—<br> (Total number of replication - 1)<br><br>${dfError}</td>
              <td>ESS=<br><br><b>${errorSumOfSquares.toFixed(2)}</b></td>
              <td><b>(C)â†’</b> RSS<hr class="Display_Divided">Z<br><br><b>${meanErrorSS.toFixed(
                2
              )}</b></td>
              <td>-</td>
              <td>ÏƒÂ²e=<br><br><b>${meanErrorSS.toFixed(2)}</b></td>
            </tr>
          </table>
          <br>
          

                <div class="formula-box">
            <p>
              <strong
                >E<sub>MSS</sub> for Treatment: ÏƒÂ²e + RÏƒÂ²g =${meanTreatmentSS.toFixed(
                  2
                )}</strong
              >
            </p>
            <p>
              <strong
                >F<sub>MSS</sub> for Error: ÏƒÂ²e =${meanErrorSS.toFixed(
                  2
                )}</strong
              >
            </p>
            <p>
              <strong
                >F<sub>MSS</sub> for Genotype: ÏƒÂ²g = [{(ÏƒÂ²e + RÏƒÂ²g) - ÏƒÂ²e}/r] =${(
                  (meanTreatmentSS - meanErrorSS) /
                  repCount
                ).toFixed(2)}</strong
              >
            </p>
            <p>
              <strong
                >F<sub>MSS</sub> for Phenotype: ÏƒÂ²p = (ÏƒÂ²g + ÏƒÂ²e) =${(
                  parseFloat(
                    ((meanTreatmentSS - meanErrorSS) / repCount).toFixed(2)
                  ) + meanErrorSS
                ).toFixed(2)}</strong
              >
            </p>
          </div>



              <div class="formula-box">
                <p>
                  <strong
                    >Mean Deviation Of Grand Total (GM): (GT / N) = ${MeanOfGrandMean}</strong
                  >
                </p>
                <p>
                  <strong
                    >Error Co-efficient of variance: (âˆšÏƒe) / GM = ${EnvironCoffVariance}</strong
                  >
                </p>
                <p>
                  <strong
                    >Genotypic Co-efficient of variance: (âˆšÏƒg) / GM = ${GeanCoffVariance}</strong
                  >
                </p>
                <p>
                  <strong
                    >Phenotypic Co-efficient of variance: (âˆšÏƒp) / GM =${PhenoCoffVariance}</strong
                  >
                </p>
              </div>
          `;

          // Find the location section to insert results
          let locationSection = document.querySelector(
            `.location-section:nth-child(${i})`
          );
          let existingFormulaBoxes =
            locationSection.querySelectorAll(".formula-box");
          existingFormulaBoxes.forEach((box) => box.remove()); // Remove previous results to prevent duplicates

          // Insert all formulas (CF, TSS, TrSS, RSS, ESS)
          let formulaBoxHTML = `
            <div class="formula-box">
                <h3>Correction Factor (C.F) Formula</h3>
                <p><strong>C.F = (GTÂ²) / (N)</strong></p>
                <p><strong>Calculation:</strong> (${grandTotal}Â² / ${N}) = 
                <span id="correctionFactor${i}">${correctionFactor.toFixed(
            2
          )}</span></p>
            </div>

            <div class="formula-box">
                <h3>Total Sum of Squares (TSS) Formula</h3>
                <p><strong>TSS = (Sum of Squares of all values) - C.F</strong></p>
                <p><strong>Calculation:</strong> (${sumOfSquaresFormula.join(
                  " + "
                )}) - (${correctionFactor.toFixed(2)}) = 
                <span id="totalSumOfSquares${i}">${totalSumOfSquares.toFixed(
            2
          )}</span></p>
            </div>

            <div class="formula-box">
                <h3>Treatment Sum of Squares (TrSS) Formula</h3>
                <p><strong>TrSS = (Sum of Squares of Treatment Totals / Number of Replication) - C.F</strong></p>
                <p><strong>Calculation:</strong> ((${treatmentSquaresFormula}) / ${repCount}) - (${correctionFactor.toFixed(
            2
          )}) = 
                <span id="treatmentSumOfSquares${i}">${finalTreatmentSum.toFixed(
            2
          )}</span></p>
            </div>

            <div class="formula-box">
                <h3>Replication Sum of Squares (RSS) Formula</h3>
                <p><strong>RSS = (Sum of Squares of Replication Totals / Number of Treatments) - C.F</strong></p>
                <p><strong>Calculation:</strong> ((${replicationFormula}) / ${treatCount}) - (${correctionFactor.toFixed(
            2
          )}) = 
                <span id="replicationSumOfSquares${i}">${finalReplicationSum.toFixed(
            2
          )}</span></p>
            </div>

            <div class="formula-box">
                <h3>Error Sum of Squares (ESS) Formula</h3>
                <p><strong>ESS = TSS - (TrSS + RSS)</strong></p>
                <p><strong>Calculation:</strong> (${totalSumOfSquares.toFixed(
                  2
                )}) - (${finalTreatmentSum.toFixed(
            2
          )} + ${finalReplicationSum.toFixed(2)}) = 
                <span id="errorSumOfSquares${i}">${errorSumOfSquares.toFixed(
            2
          )}</span></p>
            </div>`;

          locationSection.insertAdjacentHTML("beforeend", formulaBoxHTML);

          // Add Replication (Column) Totals at the Bottom
          let table = locationSection.querySelector("table");
          let existingTotalRow = table.querySelector(".total-row");

          if (existingTotalRow) {
            table.deleteRow(existingTotalRow.rowIndex);
          }

          let totalRow = table.insertRow();
          totalRow.classList.add("total-row");
          totalRow.innerHTML =
            `<td><strong>Total</strong></td>` +
            columnTotals
              .map((total) => `<td><strong>${total}</strong></td>`)
              .join("") +
            `<td><strong>Grand Total = ${grandTotal}</strong></td><td></td>`;

          document.getElementById(`grandTotal${i}`).innerText = grandTotal;

          // Insert the ANOVA Table in the location section
          locationSection.insertAdjacentHTML("beforeend", anovaTableHTML);
        }
        document.getElementById("calculateBtn").disabled = true;
        document.getElementById("summaryBtn").style.display = "block";

        // console.log(`âœ… Total Errors Sum Pooled: ${totalErrorsSumPooled}`);
        // console.log(`âœ… Total ESS Pooled: ${totalESSumPooled.toFixed(2)}`);
        // console.log(`âœ… Total MSS Pooled: ${totalMSSumPooled.toFixed(2)}`);

        // return { totalErrorsSumPooled, totalESSumPooled, totalMSSumPooled };

        globalTotalErrorsSumPooled = totalErrorsSumPooled;
        globalTotalESSumPooled = totalESSumPooled;
        globalTotalMSSumPooled = totalMSSumPooled;

        document.getElementById("dataTablesCard").style.display = "none";
        document.getElementById("resultsSection").style.display = "block";
        updateStepper(4);
      }

      function generateSummaryTable() {
        const locationCount = document.getElementById("locationCount").value;
        let maxTreatments = 0;

        // Find max treatments across locations
        for (let i = 1; i <= locationCount; i++) {
          let treatCount = parseInt(
            document.getElementById(`treatmentCount${i}`).value
          );
          if (treatCount > maxTreatments) {
            maxTreatments = treatCount;
          }
        }

        let summaryHTML = `<h3>Overall Summary Table</h3>
                 <table border="1">
                 <tr>
                   <th>Treatment</th>`;

        // Add column headers for each location
        for (let i = 1; i <= locationCount; i++) {
          summaryHTML += `<th>Location ${i}</th>`;
        }
        summaryHTML += `<th>Total</th></tr>`; // Total Column

        let grandTotal = 0;
        let locationTotals = new Array(parseInt(locationCount)).fill(0); // Store total for each location

        // Iterate through treatments (rows)
        for (let t = 1; t <= maxTreatments; t++) {
          let rowTotal = 0;
          summaryHTML += `<tr><td><strong>Treatment ${t}</strong></td>`;

          // Iterate through locations (columns)
          for (let i = 1; i <= locationCount; i++) {
            let treatCount = parseInt(
              document.getElementById(`treatmentCount${i}`).value
            );
            let meanValue =
              t <= treatCount
                ? parseFloat(
                    document.getElementById(`loc${i}treat${t}mean`).innerText
                  ) || 0
                : 0;

            summaryHTML += `<td>${meanValue.toFixed(2)}</td>`;
            rowTotal += meanValue;
            locationTotals[i - 1] += meanValue; // Correctly storing total for each location
          }

          summaryHTML += `<td><strong>${rowTotal.toFixed(
            2
          )}</strong></td></tr>`;
          grandTotal += rowTotal;
        }

        // Add Total Row (Sum of each column)
        summaryHTML += `<tr><td><strong>Total</strong></td>`;
        for (let i = 0; i < locationCount; i++) {
          summaryHTML += `<td><strong>${locationTotals[i].toFixed(
            2
          )}</strong></td>`;
        }
        summaryHTML += `<td><strong>${grandTotal.toFixed(
          2
        )}</strong></td></tr>`;

        summaryHTML += `</table>
    <button id="calculateSummaryBtn" onclick="calculateSummaryStats()">Calculate Summary Statistics</button>
    <div id="summaryStatsContainer"></div>`;

        // Display Summary Table
        document.getElementById("summaryBtn").disabled = true;
        document.getElementById("summaryTableContainer").innerHTML =
          summaryHTML;

        document.getElementById("fullReportCard").style.display = "block";
      }

      function calculateSummaryStats() {
        if (globalTotalErrorsSumPooled === 0) {
          console.warn("Please calculate totals first!");
          return;
        }

        // Use the stored global values
        let totalErrorsSumPooled = globalTotalErrorsSumPooled;
        let totalESSumPooled = globalTotalESSumPooled;
        let totalMSSumPooled = globalTotalMSSumPooled;

        console.log("Using precomputed values for summary calculations");
        const locationCount = document.getElementById("locationCount").value;
        let maxTreatments = 0;
        let grandTotal = 0;
        let treatmentTotals = [];
        let sumOfSquares = 0;

        // const { totalErrorsSumPooled, totalESSumPooled, totalMSSumPooled } =
        //   calculateTotals();

        // Find max treatments and calculate grand total
        for (let t = 1; t <= locationCount; t++) {
          let treatCount = parseInt(
            document.getElementById(`treatmentCount${t}`).value
          );
          maxTreatments = Math.max(maxTreatments, treatCount);
        }

        // console.log(`ðŸ’¡ Using Global Values in Summary Table`);
        // console.log(`âœ… Pooled Errors Sum: ${totalErrorsSumPooled}`);
        // console.log(`âœ… Pooled ESS: ${totalESSumPooled.toFixed(2)}`);
        // console.log(`âœ… Pooled MSS: ${totalMSSumPooled.toFixed(2)}`);

        // Compute Treatment Totals and Sum of Squares
        for (let t = 1; t <= maxTreatments; t++) {
          let rowTotal = 0;
          for (let i = 1; i <= locationCount; i++) {
            let treatCount = parseInt(
              document.getElementById(`treatmentCount${i}`).value
            );
            let meanValue =
              t <= treatCount
                ? parseFloat(
                    document.getElementById(`loc${i}treat${t}mean`).innerText
                  ) || 0
                : 0;
            rowTotal += meanValue;
            sumOfSquares += meanValue ** 2;
          }
          treatmentTotals.push(rowTotal);
          grandTotal += rowTotal;
        }

        let N = maxTreatments * locationCount; // Total number of observations
        let correctionFactor = grandTotal ** 2 / N; // CF Calculation

        // Total Sum of Squares (TSS)
        let totalSumOfSquares = sumOfSquares - correctionFactor;

        // Treatment Sum of Squares (TrSS)
        let treatmentSquaresSum = treatmentTotals.reduce(
          (sum, value) => sum + value ** 2,
          0
        );
        let treatmentSumOfSquares =
          treatmentSquaresSum / locationCount - correctionFactor;

        // Replication Sum of Squares (RSS)
        let replicationTotals = new Array(locationCount).fill(0);
        for (let i = 1; i <= locationCount; i++) {
          let colTotal = 0;
          for (let t = 1; t <= maxTreatments; t++) {
            let treatCount = parseInt(
              document.getElementById(`treatmentCount${i}`).value
            );
            let meanValue =
              t <= treatCount
                ? parseFloat(
                    document.getElementById(`loc${i}treat${t}mean`).innerText
                  ) || 0
                : 0;
            colTotal += meanValue;
          }
          replicationTotals[i - 1] = colTotal;
        }
        let replicationSquaresSum = replicationTotals.reduce(
          (sum, value) => sum + value ** 2,
          0
        );
        let replicationSumOfSquares =
          replicationSquaresSum / maxTreatments - correctionFactor;

        // Error Sum of Squares (ESS)
        let errorSumOfSquares =
          totalSumOfSquares - (treatmentSumOfSquares + replicationSumOfSquares);

        // Display Results
        let summaryStatsHTML = `
    <h3>Summary Table Calculations</h3>
    <div class="formula-box">
        <p><strong>Correction Factor (CF):</strong> (${grandTotal}Â² / ${N}) = <b>${correctionFactor.toFixed(
          2
        )}</b></p>
        <p><strong>Total Sum of Squares (TSS):</strong> (${sumOfSquares} - ${correctionFactor}) = <b>${totalSumOfSquares.toFixed(
          2
        )}</b></p>
        <p><strong>Treatment Sum of Squares (TrSS):</strong> (${treatmentSquaresSum} / ${locationCount} - ${correctionFactor}) = <b>${treatmentSumOfSquares.toFixed(
          2
        )}</b></p>
        <p><strong>Replication Sum of Squares (RSS):</strong> (${replicationSquaresSum} / ${maxTreatments} - ${correctionFactor}) = <b>${replicationSumOfSquares.toFixed(
          2
        )}</b></p>
        <p><strong>Error Sum of Squares (ESS):</strong> (${totalSumOfSquares} - (${treatmentSumOfSquares} + ${replicationSumOfSquares})) = <b>${errorSumOfSquares.toFixed(
          2
        )}</b></p>
    </div>`;

        document.getElementById("summaryStatsContainer").innerHTML =
          summaryStatsHTML;
        document.getElementById("calculateSummaryBtn").disabled = true; // Disable the button after calculation

        let Z = (maxTreatments - 1) * (locationCount - 1);

        let A = treatmentSumOfSquares.toFixed(2) / (maxTreatments - 1);
        let B = replicationSumOfSquares.toFixed(2) / (locationCount - 1);
        let C = errorSumOfSquares.toFixed(2) / Z; //ESS MSS (C)

        let I = (A / C).toFixed(2);
        let J = (B / C).toFixed(2);

        let SummaryAnovaTableHTML = `
          <table>
            <tr>
              <th>Source of Variation</th>
              <th>Degree of Freedom (d.f)</th>
              <th>Sum of Square (SS)</th>
              <th>Mean Sum of Square (MSS)</th>
              <th>F<sub>cal</sub></th>
              <th>E<sub>MSS</sub></th>
            </tr>
            <tr>
              <td><b>Treatment (T)</b></td>
              <td>(Total number of treatments - 1)<br><br><b>${
                maxTreatments - 1
              }</b></td>
              <td>TrSS=<br><br><b>${treatmentSumOfSquares.toFixed(2)}</b></td>
              <td><b>(A)â†’</b>TrSS<hr class="Display_Divided">(Total number of treatments - 1)<br><br><b>${A}</b></td>
              <td>A<hr class="Display_Divided">C<br><br><b>${I}</b></td>
              <td>(ÏƒÂ²e + RÏƒÂ²g + lÏƒÂ²g)<br><br><b>${A}</b></td>
            </tr>
            <tr>
              <td><b>Replication (R)</b></td>
              <td>(Total number of replication - 1)<br><br><b>${
                locationCount - 1
              }</b></td>
              <td>RSS=<br><br><b>${replicationSumOfSquares.toFixed(2)}</b></td>
              <td><RSS><b>(B)â†’</b>RSS<hr class="Display_Divided">(Total number of replication - 1)<br><br><b>${B}</b></td>
              <td>B<hr class="Display_Divided">C<br><br><b>${J}</b></td>
              <td>(ÏƒÂ²e + ÏƒÂ²gl + gÏƒÂ²l)</td>
            </tr>
            <tr>
              <td><b>Error (E)</b></td>
              <td><b>(Z)â†’</b> (Total number of treatments - 1) Ã—<br> (Total number of replication - 1)<br><br>${Z}</td>
              <td>ESS=<br><br><b>${errorSumOfSquares.toFixed(2)}</b></td>
              <td><b>(C)â†’</b> RSS<hr class="Display_Divided">Z<br><br><b>${C}</b></td>
              <td>-</td>
              <td>(ÏƒÂ²e + ÏƒÂ²gl)<br><br><b>${C}</b></td>
            </tr>
            <tr>
                <td><b>Pooled Error</b></td>
                <td>Sum of individual locations<br><br>${totalErrorsSumPooled}</td>
                <td>Sum of individual locations SS<br><br><b>${totalESSumPooled.toFixed(
                  2
                )}</b></td>
                <td><b>Sum of individual locations MSS</b><br><br>${totalMSSumPooled.toFixed(
                  2
                )}</td>
                <td>-</td>
                <td>ÏƒÂ²e=<br><br><b>${totalMSSumPooled.toFixed(2)}</b></td>
            </tr>
          </table>
        `;
        document.getElementById("SummaryAnovaResults").innerHTML =
          SummaryAnovaTableHTML;
      }

      document
        .getElementById("downloadBtn")
        .addEventListener("click", function () {
          generatePDF();
          generateExcel();
        });

      function generatePDF() {
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF({
          orientation: "portrait",
          unit: "mm",
          format: "a4",
        });

        window.scrollTo(0, 0); // Ensure full-page capture
        html2canvas(document.body, {
          scale: 2,
          useCORS: true,
        }).then((canvas) => {
          let imgData = canvas.toDataURL("image/png");
          let imgWidth = 210; // A4 width in mm
          let pageHeight = 297; // A4 height in mm
          let imgHeight = (canvas.height * imgWidth) / canvas.width;
          let heightLeft = imgHeight;
          let position = 0;

          // Function to add gray transparent header text
          // function addHeader(doc) {
          //   doc.setTextColor(200, 200, 200); // Light gray color
          //   doc.setFontSize(16);
          //   doc.setFont("helvetica", "bold");
          //   doc.text("BARGAND", 5, 10, { opacity: 0.5 }); // Top-left corner, semi-transparent
          // }

          doc.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
          // addHeader(doc); // Add header on first page
          heightLeft -= pageHeight;

          while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            doc.addPage();
            doc.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
            // addHeader(doc); // Add header on each new page
            heightLeft -= pageHeight;
          }

          doc.save("ANOVA_Calculations.pdf");
        });
      }

      // Update stepper navigation
      function updateStepper(activeStep) {
        const steps = document.querySelectorAll(".step");
        steps.forEach((step, index) => {
          step.classList.remove("active", "completed");
          if (index + 1 < activeStep) {
            step.classList.add("completed");
          } else if (index + 1 === activeStep) {
            step.classList.add("active");
          }
        });
      }

      // Navigation functions
      function backToSetup() {
        document.getElementById("setupCard").style.display = "block";
        document.getElementById("locationDetailsCard").style.display = "none";
        updateStepper(1);
      }

      function backToDetails() {
        document.getElementById("locationDetailsCard").style.display = "block";
        document.getElementById("dataTablesCard").style.display = "none";
        updateStepper(2);
      }

      function backToTables() {
        document.getElementById("dataTablesCard").style.display = "block";
        document.getElementById("resultsSection").style.display = "none";
        updateStepper(3);
      }
      updateStepper(1);
    </script>
  </body>
</html>
